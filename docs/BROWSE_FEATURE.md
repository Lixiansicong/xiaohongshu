# 小红书推荐页浏览功能

> 💡 **最新优化**：已升级为 v2.0，基于真实用户行为数据优化  
> 📖 查看详细说明：[人类行为模拟优化文档](./BEHAVIOR_OPTIMIZATION.md)

## 功能概述

该功能模拟人类用户在小红书推荐页的浏览行为，包括：

- 🖱️ **滚动浏览**：模拟人类习惯的滚动操作（鼠标滚轮、键盘方向键、JS 滚动）
- 👆 **随机点击**：根据设定概率随机点击笔记进入详情页
- 👁️ **内容浏览**：浏览笔记内容、评论区
- ❤️ **互动操作**：根据概率进行点赞、收藏、评论（三个操作一起执行）
- 📊 **统计数据**：返回详细的浏览统计信息

## API 使用方式

### HTTP API

**接口地址**：`POST /api/v1/browse/recommendations`

**请求参数**：

```json
{
  "duration": 10,                    // 浏览时长（分钟），默认10分钟
  "min_scrolls": 3,                  // 每轮最小滚动次数，默认3次
  "max_scrolls": 8,                  // 每轮最大滚动次数，默认8次
  "click_probability": 40,           // 点击笔记的概率(0-100)，默认30%
  "interact_probability": 60,        // 在笔记中互动的概率(0-100)，默认50%
  "comments": [                      // 评论内容列表（可选）
    "写得真好！",
    "学到了～",
    "感谢分享",
    "太实用了"
  ]
}
```

**响应示例**：

```json
{
  "success": true,
  "data": {
    "duration": "10m0s",
    "scroll_count": 45,
    "click_count": 12,
    "like_count": 7,
    "favorite_count": 7,
    "comment_count": 5,
    "viewed_notes": [
      "note_id_1",
      "note_id_2",
      "..."
    ]
  },
  "message": "浏览推荐页完成"
}
```

### MCP 工具调用

**工具名称**：`browse_recommendations`

**工具描述**：模拟人类浏览小红书推荐页，包括滚动、随机点击笔记、浏览评论区，并有概率进行点赞、收藏、评论等互动操作

**参数说明**：

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| duration | int | 否 | 10 | 浏览时长（分钟） |
| min_scrolls | int | 否 | 3 | 每轮最小滚动次数 |
| max_scrolls | int | 否 | 8 | 每轮最大滚动次数 |
| click_probability | int | 否 | 30 | 点击笔记的概率(0-100) |
| interact_probability | int | 否 | 50 | 在笔记中互动的概率(0-100) |
| enable_comment | bool | 否 | true | 是否启用评论功能 |
| comments | []string | 否 | [] | 评论内容列表（为空时自动从评论区获取） |

## 评论功能使用说明

浏览推荐页功能支持灵活的评论控制，你可以：

### 1. 禁用评论

当你不想进行任何评论时，设置 `enable_comment: false`：

```json
{
  "tool": "browse_recommendations",
  "duration": 10,
  "enable_comment": false
}
```

**效果**：
- ✅ 会点赞和收藏
- ❌ 不会评论

### 2. 使用自定义评论内容

提供你自己的评论内容列表，系统会随机选择使用：

```json
{
  "tool": "browse_recommendations",
  "duration": 10,
  "comments": ["太棒了！", "很有用！", "学到了！"]
}
```

**效果**：
- ✅ 会从你提供的列表中随机选择评论
- 评论概率：50%

### 3. 自动获取评论（默认，推荐）

不提供任何评论相关参数，系统会自动从评论区获取评论文本：

```json
{
  "tool": "browse_recommendations",
  "duration": 10
}
```

**效果**：
- ✅ 会自动从笔记的评论区复制其他用户的评论
- ✅ 评论内容更自然，不会被识别为机器人
- 评论概率：50%

### 评论逻辑流程

```
1. 检查 enable_comment
   ├─ false → 跳过评论
   └─ true 或未设置 → 继续

2. 50% 概率触发评论
   ├─ 未触发 → 跳过评论
   └─ 触发 → 继续

3. 获取评论内容
   ├─ 如果提供了 comments → 使用自定义内容
   └─ 如果未提供 comments → 从评论区自动获取

4. 执行评论
```

### 实际使用场景

**场景 1：只浏览，不评论**

```
用户："帮我浏览小红书推荐页10分钟，但是不要评论"
```

AI 会调用：
```json
{
  "tool": "browse_recommendations",
  "duration": 10,
  "enable_comment": false
}
```

**场景 2：自动模拟真实用户行为（推荐）**

```
用户："帮我浏览小红书推荐页，要像真人一样互动"
```

AI 会调用（不传评论参数，自动获取）：
```json
{
  "tool": "browse_recommendations",
  "duration": 10
}
```

**场景 3：使用特定评论内容**

```
用户："帮我浏览小红书，评论时用这些内容：'好看'、'喜欢'、'收藏了'"
```

AI 会调用：
```json
{
  "tool": "browse_recommendations",
  "duration": 10,
  "comments": ["好看", "喜欢", "收藏了"]
}
```

### 评论功能注意事项

1. **评论概率**：即使启用了评论，也只有 50% 的概率会在互动时评论（模拟真实用户行为）
2. **互动概率**：只有当笔记触发互动时（由 `interact_probability` 控制，默认 50%），才会进行点赞、收藏和评论
3. **自动获取评论**：从评论区获取的评论会自动过滤（长度 5-100 字符），确保评论质量
4. **推荐使用自动获取**：默认的自动获取评论功能是最自然的方式，推荐使用

---

**使用示例**：

在 Cursor、VSCode 或其他 MCP 客户端中：

```
帮我使用小红书浏览推荐页功能，浏览5分钟，点击概率设置为50%，互动概率设置为70%，
并使用以下评论内容：["太棒了！", "学到了", "感谢分享", "实用～"]
```

或直接调用：

```json
{
  "tool": "browse_recommendations",
  "arguments": {
    "duration": 5,
    "click_probability": 50,
    "interact_probability": 70,
    "comments": ["太棒了！", "学到了", "感谢分享", "实用～"]
  }
}
```

## 工作流程

1. **导航到推荐页**
   - 访问 `https://www.xiaohongshu.com/explore`
   - 等待页面加载完成

2. **循环浏览**（直到达到设定时长）
   - 随机滚动 3-8 次（可配置）
   - 每次滚动后停留 3-6 秒（中位数）
   - 根据概率决定是否点击笔记

3. **点击笔记**（当触发点击概率时）
   - 获取当前可见的笔记卡片
   - 随机选择一个笔记点击进入
   - 浏览笔记内容（2-4秒）
   - 滚动查看图片/视频
   - 60% 概率浏览评论区

4. **互动操作**（当触发互动概率时）
   - 点赞笔记（复用现有 `LikeAction`）
   - 收藏笔记（复用现有 `FavoriteAction`）
   - 70% 概率发表评论（从评论列表随机选择）

5. **关闭笔记**（自然退出）
   - 等待 0.8-1.5 秒
   - 60% 概率使用 ESC 键关闭
   - 40% 概率点击遮罩层/空白处关闭
   - 保留滚动位置，不刷新页面
   - 继续下一轮浏览

## 防检测策略

### 1. 行为随机化
- **滚动方式随机**：鼠标滚轮、键盘、JS滚动三种方式随机切换
- **滚动距离随机**：300-900 像素
- **停留时间随机**：中位数 3-6 秒，符合真实用户浏览习惯
- **浏览路径随机**：随机选择笔记进入

### 2. 真实用户行为参数（基于实际数据优化）
- **滚动段时长**：0.6-2.5 秒，模拟真实滚动速度
- **插入短暂停**：0.2-1.2 秒，模拟用户停顿查看
- **回滚概率**：7-18%，模拟用户向上回看行为
- **分段滚动**：将滚动分成 2-4 段，更加自然

### 3. 时间控制
- 所有操作添加随机延迟
- 模拟真实的阅读时间
- 避免过于规律的操作间隔

### 4. 概率机制
- 不是每次滚动都点击笔记
- 不是每个笔记都进行互动
- 模拟真实用户的选择性行为

### 5. 复用现有功能
- **完全复用**现有的点赞/收藏/评论功能实现
- 调用 `NewLikeAction`、`NewFavoriteAction`、`NewCommentFeedAction`
- 继承所有已验证的安全方法和防检测机制
- 保持 cookies 和状态一致性
- 与直接调用 MCP 工具的效果完全一致

### 6. 自然退出机制
- **不刷新页面**：小红书笔记详情是悬浮弹窗，使用 ESC 键或点击遮罩层关闭
- **保留滚动位置**：退出后继续当前位置浏览，更符合真实行为
- **随机关闭方式**：60% ESC 键，40% 点击遮罩，增加行为多样性
- **降级机制**：若关闭失败，自动降级为刷新页面

## 配置建议

### 轻度浏览（观察型用户）
```json
{
  "duration": 5,
  "click_probability": 20,
  "interact_probability": 30,
  "comments": ["不错～", "学到了"]
}
```

### 中度浏览（普通用户）
```json
{
  "duration": 10,
  "click_probability": 40,
  "interact_probability": 50,
  "comments": [
    "看完感觉收获很多，马上就去试试",
    "这个角度真的很新颖",
    "说得太对了",
    "保存下来慢慢看，感谢分享",
    "这个方法确实挺管用的",
    "原来还可以这样，学到了",
    "照片拍得真好看",
    "有点心动了",
    "这个必须收藏"
  ]
}
```

### 重度浏览（活跃用户）
```json
{
  "duration": 15,
  "click_probability": 60,
  "interact_probability": 70,
  "comments": [
    "看完感觉收获很多，马上就去试试",
    "这个角度真的很新颖，之前完全没想到",
    "哈哈哈笑死我了，太真实了",
    "终于找到同好了！我也一直这么觉得",
    "楼主说得太对了，我昨天刚好遇到这个问题",
    "保存下来慢慢看，感谢分享",
    "这个方法我试过，确实挺管用的",
    "照片拍得真好看，是哪里呀",
    "有点心动，想入手了",
    "原来还可以这样，学到了",
    "说得太到位了，一下子就懂了",
    "这个必须收藏！太实用了",
    "看完就想出去走走了",
    "期待后续更新～",
    "已经关注了，持续追更"
  ]
}
```

## 注意事项

1. **登录状态**：使用前必须确保已登录小红书
2. **运行时间**：建议单次浏览不超过 30 分钟
3. **评论内容**：建议提供多样化的评论内容，避免过于机械
4. **概率设置**：不建议设置过高的概率，保持真实性
5. **网络稳定**：确保网络连接稳定，避免中断
6. **无头模式**：生产环境建议使用无头模式（-headless=true）

## 统计指标说明

返回的统计数据包括：

- **duration**: 实际浏览时长
- **scroll_count**: 总滚动次数
- **click_count**: 点击笔记次数
- **like_count**: 点赞次数
- **favorite_count**: 收藏次数
- **comment_count**: 评论次数
- **viewed_notes**: 浏览过的笔记 ID 列表

## 故障排查

### 问题：无法点击笔记
- 检查推荐页是否正常加载
- 确认笔记卡片选择器是否正确（`section.note-item`）
- 查看日志中的详细错误信息

### 问题：互动操作失败
- 确认已登录小红书
- 检查 feed_id 和 xsec_token 是否正确提取
- 查看具体的互动操作日志

### 问题：浏览提前结束
- 检查是否有 context 取消
- 查看是否有网络错误
- 确认浏览器进程是否正常

## 扩展性

该功能设计为可扩展的模块，可以轻松添加：

- 更多的浏览策略
- 不同的互动模式
- 自定义的浏览路径
- 更精细的行为模拟

如需自定义，可以修改 `xiaohongshu/browse.go` 文件中的相关逻辑。

